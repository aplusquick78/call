name: Generate Town Pages

on:
  push:
    paths:
      - '_data/towns.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Run Generator Script
        run: |
          python - <<EOF
          import yaml
          import os
          import shutil

          if os.path.exists('_towns'):
              shutil.rmtree('_towns')
          os.makedirs('_towns')

          with open('_data/towns.yml', 'r', encoding='utf-8') as f:
              data = yaml.safe_load(f)

          for region_group in data:
              reg = region_group['region']
              # 1. 시/도 페이지 생성 (예: 인천퀵서비스)
              reg_name = reg.replace(" ", "")
              with open(f"_towns/{reg_name}.md", 'w', encoding='utf-8') as f:
                  f.write(f"---\ntown: {reg_name}\ntown_full: {reg}\n---")

              for dist_group in region_group['districts']:
                  dist = dist_group['name']
                  # 2. 구/군 페이지 생성 (예: 부평구퀵서비스)
                  dist_name = dist.replace(" ", "")
                  if not os.path.exists(f"_towns/{dist_name}.md"):
                      with open(f"_towns/{dist_name}.md", 'w', encoding='utf-8') as f:
                          f.write(f"---\ntown: {dist_name}\ntown_full: {reg} {dist}\n---")

                  for town in dist_group['towns']:
                      # 3. 동네 페이지 생성 (기존과 동일)
                      filename = f"_towns/{town}.md"
                      if os.path.exists(filename):
                          filename = f"_towns/{dist}{town}.md"
                      
                      with open(filename, 'w', encoding='utf-8') as f:
                          f.write(f"---\ntown: {town}\ntown_full: {reg} {dist} {town}\n---")
          EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Automated town pages generation" || exit 0
          git push
