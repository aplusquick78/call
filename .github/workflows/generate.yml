name: Generate Town Pages

on:
  workflow_dispatch:
  push:
    paths:
      - '_data/towns.yml'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Run Generator Script
        run: |
          python - <<EOF
          import yaml
          import os
          import shutil

          # 1. _towns 폴더 초기화
          if os.path.exists('_towns'):
              shutil.rmtree('_towns')
          os.makedirs('_towns')

          with open('_data/towns.yml', 'r', encoding='utf-8') as f:
              data = yaml.safe_load(f)

          for region_group in data:
              reg = region_group['region']
              # 시/도 (예: 인천광역시) -> 괄호나 공백 제거
              reg_clean = reg.split('(')[0].strip()
              with open(f"_towns/{reg_clean}.md", 'w', encoding='utf-8') as f:
                  f.write(f"---\ntown: {reg_clean}\ntown_full: {reg}\n---")

              for dist_group in region_group['districts']:
                  dist = dist_group['name']
                  dist_clean = dist.strip()
                  
                  # 구/군 생성
                  dist_filename = f"_towns/{dist_clean}.md"
                  if os.path.exists(dist_filename):
                      dist_filename = f"_towns/{reg_clean}{dist_clean}.md"
                  
                  with open(dist_filename, 'w', encoding='utf-8') as f:
                      f.write(f"---\ntown: {dist_clean}\ntown_full: {reg} {dist}\n---")

                  for town in dist_group['towns']:
                      town_clean = town.strip()
                      filename = f"_towns/{town_clean}.md"
                      if os.path.exists(filename):
                          filename = f"_towns/{dist_clean}{town_clean}.md"
                      
                      with open(filename, 'w', encoding='utf-8') as f:
                          f.write(f"---\ntown: {town_clean}\ntown_full: {reg} {dist} {town}\n---")
          EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add _towns/
          git commit -m "Auto-generate city and town pages" || exit 0
          git push
